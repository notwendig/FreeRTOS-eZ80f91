   1:				include CPM.INC
**** ./CPM22/CPM.INC ****
   1:				
   2:				;	CBIOS for eZ80 Z80-Mixed-Mode
   3:				;
   4:				;	Copyright (C) 1998-2021 by Juergen Sievers
   5:				;
   6:     -	0040          	MEM:		EQU	64	;cp/m version memory size in kilobytes
   7:				;
   8:				;	"bias" is address offset from 3400H for memory systems
   9:				;	than 16K (referred to as "b" throughout the text).
  10:				;
  11:     -	B000          	BIAS:	EQU	(MEM-20)*1024
  12:     -	E400          	CCP:	EQU	3400H+BIAS	;base of ccp
  13:     -	EC06          	BDOS:	EQU	CCP+806H	;base of bdos
  14:     -	FA00          	BIOS:	EQU	CCP+1600H	;base of bios
  15:     -	0004          	CDISK:	EQU	0004H		;current disk number 0=A,...,15=P
  16:				
  17:				;
  18:				;   BIOS entrys
  19:				;
  20:     -	FA00          	BOOT 	equ BIOS+3*0   ;cold start
  21:     -	FA03          	WBOOT 	equ BIOS+3*1   ;warm start
  22:     -	FA06          	CONST 	equ BIOS+3*2   ;console status
  23:     -	FA09          	CONIN 	equ BIOS+3*3   ;console character in
  24:     -	FA0C          	CONOUT  equ BIOS+3*4   ;console character out
  25:     -	FA0F          	PLIST 	equ BIOS+3*5   ;list character out
  26:     -	FA12          	PUNCH 	equ BIOS+3*6   ;punch character out
  27:     -	FA15          	READER  equ BIOS+3*7   ;reader character out
  28:     -	FA18          	HOME 	equ BIOS+3*8   ;move head to home position
  29:     -	FA1B          	SELDSK  equ BIOS+3*9   ;select disk
  30:     -	FA1E          	SETTRK  equ BIOS+3*10  ;set track number
  31:     -	FA21          	SETSEC  equ BIOS+3*11  ;set sector number
  32:     -	FA24          	SETDMA  equ BIOS+3*12  ;set dma address
  33:     -	FA27          	READ 	equ BIOS+3*13  ;read disk
  34:     -	FA2A          	WRITE 	equ BIOS+3*14  ;write disk
  35:     -	FA2D          	LISTST  equ BIOS+3*15  ;return list status
  36:     -	FA30          	SECTRN  equ BIOS+3*16  ;sector translate
  37:				
  38:				;
  39:				;   Set control character equates.
  40:				;
  41:     -	0003          	CNTRLC	EQU	3		;control-c
  42:     -	0005          	CNTRLE	EQU	05H		;control-e
  43:     -	0008          	BS		EQU	08H		;backspace
  44:     -	0009          	TAB		EQU	09H		;tab
  45:     -	000A          	LF		EQU	0AH		;line feed
  46:     -	000C          	FF		EQU	0CH		;form feed
  47:     -	000D          	CR		EQU	0DH		;carriage return
  48:     -	0010          	CNTRLP	EQU	10H		;control-p
  49:     -	0012          	CNTRLR	EQU	12H		;control-r
  50:     -	0013          	CNTRLS	EQU	13H		;control-s
  51:     -	0015          	CNTRLU	EQU	15H		;control-u
  52:     -	0018          	CNTRLX	EQU	18H		;control-x
  53:     -	001A          	CNTRLZ	EQU	1AH		;control-z (end-of-file mark)
  54:     -	007F          	DEL		EQU	7FH		;rubout
  55:				
  56:     -	0003          	IOBYTE	EQU	3		;i/o definition byte.
  57:     -	0004          	TDRIVE	EQU	4		;current drive name and user number.
  58:     -	0005          	ENTRY	EQU	5		;entry point for the cp/m bdos.
  59:     -	005C          	TFCB	EQU	5CH		;default file control block.
  60:     -	0080          	TBUFF	EQU	80H		;i/o buffer and command line storage.
  61:     -	0100          	TBASE	EQU	100H		;transiant program storage area.
  62:				
  63:				
  64:				SERIALNO macro
  65:						db	0,22,0,0,0,0
  66:						endm
**** ./CPM22/BOOT.ASM ****
   2:				include HWC.INC
**** ./CPM22/HWC.INC ****
   1:				; eZ80F91 FreeRTOS Z80 CP/M 2.2 Hardware simulation
   2:				
   3:     -	DC00          	LOADER: EQU 0DC00h		;Bootloader entry after start
   4:				;
   5:				;	I/O ports
   6:				;
   7:     -	0030          	MONITOR: EQU 30h
   8:				
   9:     -	0031          	CONIO:	EQU 31h		; CONOLE, PRT, AUX Device
  10:     -	0001          	CONSTA:	EQU	01h		;console status port
  11:     -	0002          	CONDAT:	EQU	02h		;console data port
  12:     -	0003          	PRTSTA:	EQU	03h		;printer status port
  13:     -	0004          	PRTDAT:	EQU	04h		;printer data port
  14:     -	0005          	AUXDAT:	EQU	05h		;auxiliary data port
  15:				
  16:     -	0032          	FDIO:	EQU 32h		; FLOPPY Device
  17:     -	0001          	FDCD:	EQU	01h		;fdc-port: # of drive in A. 0 = A, 1 = B ... HL points to DPH
  18:     -	0002          	FDCTBC:	EQU	02h		;fdc-port: # of track in BC
  19:     -	0003          	FDCSBC:	EQU	03h		;fdc-port: # of sector in BC
  20:     -	0004          	FDCOP:	EQU	04h		;fdc-port: command	A == 0 write, 1 read
  21:     -	0005          	FDCST:	EQU	05h		;fdc-port: status	Disk Status to A
  22:				
  23:     -	0033          	DMAIO:	EQU 33h		; DMA Device
  24:     -	0001          	DMABC:	EQU	01h		;dma-port: dma address BC
  25:				
  26:     -	0034          	ROMBOOT:EQU	34h		; boot buildin CP/M 2.2
  27:     -	0035          	BDOSCALL:EQU 35h
  28:				
  29:     -	0000          	PORTOUT:EQU	0
  30:     -	0001          	PORTINP:EQU	1
  31:				
  32:				; Execute ADL=1 mode code from ADL=0 mode (plain Z80-mode) code by casing a trap exception.
  33:				; Macro to tram ez80f91 on z80 mixed mode
  34:				; for simulat io
  35:				; $cb, device ($30..$35), direction (0=in,1=out), port
  36:				EXBIOS  MACRO device, direction, port
  37:					db	0cbh, device, direction, port
  38:					ENDM
  39:				
  40:				EXBDOS MACRO
  41:					db BDOSCALL
  42:					ENDM
  43:				
**** ./CPM22/BOOT.ASM ****
   3:				
   4:     -	1C00          	SIZE:    EQU     (10000h-CCP)  	; size of cp/m system
   5:     -	0032          	SECTS:   EQU     32h			;(SIZE / 128)   ; # of sectors to load
   6:				
   7:     -	DC00          		ORG	LOADER
   8:					
   9:				
  10:    0+10	DC00  318000  	_loader:LD		SP,80h
  11:   10+17	DC03  CD73DC  			CALL	cprn
  12:     -	DC06  43502F4D			DB 		"CP/M 2.2 Loader v1.0 ",0
	              20322E32
	              204C6F61
	              64657220
	              76312E30
	              2000
  13:   27+4	DC1C  AF      			XOR		A,A				; a =0 select drive A
  14:   31+15	DC1D  ED62    			SBC		HL,HL			; HL=0 IBM 3740 default dph
  15:     -	DC1F          			EXBIOS  FDIO, 0, FDCD	; select drive a
  15:     -	DC1F  CB320001		db	0cbh, FDIO, 0, FDCD
  15:     -	DC23          		ENDM
  16:     -	DC23          			EXBIOS  FDIO, 1, FDCST  ; get status of fdc
  16:     -	DC23  CB320105		db	0cbh, FDIO, 1, FDCST
  16:     -	DC27          		ENDM
  17:				
  18:   46+7	DC27  2E02    			LD      L,2             ; h=track 0, l=sector 2
  19:   53+7	DC29  1632    			LD      D,SECTS         ; d=# sectors to load
  20:   60+14	DC2B  DD2100E4	 		LD      IX,CCP          ; base transfer address
  21:   74+4	DC2F  B7      			OR		A				; selected?
  22:   78+7+5	DC30  203D    			JR		NZ,EXMON		; yes read system
  23:				;
  24:				;       load the next sector
  25:				;
  26:   85+7	DC32  3E2E    	NEXTS:	LD		A,'.'
  27:     -	DC34          			EXBIOS	CONIO, 0, CONDAT
  27:     -	DC34  CB310002		db	0cbh, CONIO, 0, CONDAT
  27:     -	DC38          		ENDM
  28:   92+15	DC38  DD39    			ADD		IX,SP           ; 128 bytes per sector
  29:  107+4	DC3A  2C      			INC     L               ; sector = sector + 1
  30:  111+4	DC3B  7D      			LD      A,L
  31:  115+7	DC3C  FE1B    			CP      27              ; last sector of track ?
  32:  122+7+5	DC3E  3803    			JR      C,$F1	        ; no, go read another
  33:				;
  34:				;       end of track, increment to next track
  35:				;
  36:  129+7	DC40  2E01    			LD      L,1             ; sector = 1
  37:  136+4	DC42  24      			INC     H               ; track = track + 1
  38:  140+4	DC43  AF      	$F1: 	XOR     A
  39:  144+4	DC44  47      			LD		B,A
  40:  148+4	DC45  4C      			LD		C,H				; set track
  41:     -	DC46          			EXBIOS  FDIO, 0, FDCTBC
  41:     -	DC46  CB320002		db	0cbh, FDIO, 0, FDCTBC
  41:     -	DC4A          		ENDM
  42:  152+4	DC4A  4D      			LD      C,L             ; set sector
  43:     -	DC4B          			EXBIOS  FDIO, 0, FDCSBC
  43:     -	DC4B  CB320003		db	0cbh, FDIO, 0, FDCSBC
  43:     -	DC4F          		ENDM
  44:  156+15	DC4F  DDE5    			PUSH	IX
  45:  171+10	DC51  C1      			POP		BC				; set dma
  46:     -	DC52          			EXBIOS  DMAIO, 0, DMABC
  46:     -	DC52  CB330001		db	0cbh, DMAIO, 0, DMABC
  46:     -	DC56          		ENDM
  47:     -	DC56          			EXBIOS  FDIO, 0, FDCOP	; a=0 => read sector
  47:     -	DC56  CB320004		db	0cbh, FDIO, 0, FDCOP
  47:     -	DC5A          		ENDM
  48:     -	DC5A          			EXBIOS  FDIO, 1, FDCST  ; get status of fdc
  48:     -	DC5A  CB320105		db	0cbh, FDIO, 1, FDCST
  48:     -	DC5E          		ENDM
  49:  181+4	DC5E  B7      			OR      A               ; read successful ?
  50:  185+7+5	DC5F  200E    			JR      NZ,EXMON        ; no, start buildin monitor
  51:				
  52:  192+4	DC61  15      			DEC     D               ; sects--
  53:  196+7+5	DC62  20CE    			JR      NZ,NEXTS        ; head for the bios
  54:  203+17	DC64  CD73DC  			CALL	cprn
  55:     -	DC67  4F4B0D0A			DB 		"OK",CR,LF,0
	              00
  56:  220+10	DC6C  C300FA  			JP		BOOT
  57:				
  58:						
  59:     -	DC6F          	EXMON:	EXBIOS  MONITOR, 0, 0	; build-in monitor
  59:     -	DC6F  CB300000		db	0cbh, MONITOR, 0, 0
  59:     -	DC73          		ENDM
  60:				
  61:  230+10	DC73  E1      	cprn:	POP		HL
  62:  240+7	DC74  7E      	$B1:	LD		A,(HL)
  63:  247+6	DC75  23      			INC		HL
  64:  253+4	DC76  B7      			OR		A
  65:  257+7+5	DC77  2806    			JR		Z,$F2
  66:     -	DC79          			EXBIOS	CONIO, 0, CONDAT
  66:     -	DC79  CB310002		db	0cbh, CONIO, 0, CONDAT
  66:     -	DC7D          		ENDM
  67:  264+12	DC7D  18F5    			JR		$B1
  68:  276+4	DC7F  E9      	$F2:	JP		(HL)
  69:				
  70:     -	0000          	.if $ < 80h
  71:						DS _loader + 80h - $,0
  72:				.endif
  73:				
  74:     -	0000          	.if $ <> _loader + 80h
  75:					.error
  76:				.endif
  77:     -	DC80          	_LOADEREND	equ	$	
  78:				
  79:     -	DC80          		END



Statistics:

     4	passes
     0	jr promotions
    73	symbols
   128	bytes

    10	macro calls
    74	macro bytes
     0	invented symbols



Symbol Table:

AUXDAT         =05        5
B1              DC74      56436
BDOS           =EC06      60422
BDOSCALL       =35        53
BIAS           =B000      45056
BIOS           =FA00      64000
BOOT           =FA00      64000
BS             =08        8
CCP            =E400      58368
CDISK          =04        4
CNTRLC         =03        3
CNTRLE         =05        5
CNTRLP         =10        16
CNTRLR         =12        18
CNTRLS         =13        19
CNTRLU         =15        21
CNTRLX         =18        24
CNTRLZ         =1A        26
CONDAT         =02        2
CONIN          =FA09      64009
CONIO          =31        49
CONOUT         =FA0C      64012
CONST          =FA06      64006
CONSTA         =01        1
CR             =0D        13
DEL            =7F        127
DMABC          =01        1
DMAIO          =33        51
ENTRY          =05        5
EXMON           DC6F      56431
F1              DC43      56387
F2              DC7F      56447
FDCD           =01        1
FDCOP          =04        4
FDCSBC         =03        3
FDCST          =05        5
FDCTBC         =02        2
FDIO           =32        50
FF             =0C        12
HOME           =FA18      64024
IOBYTE         =03        3
LF             =0A        10
LISTST         =FA2D      64045
LOADER         =DC00      56320
MEM            =40        64
MONITOR        =30        48
NEXTS           DC32      56370
PLIST          =FA0F      64015
PORTINP        =01        1
PORTOUT        =00        0
PRTDAT         =04        4
PRTSTA         =03        3
PUNCH          =FA12      64018
READ           =FA27      64039
READER         =FA15      64021
ROMBOOT        =34        52
SECTRN         =FA30      64048
SECTS          =32        50
SELDSK         =FA1B      64027
SETDMA         =FA24      64036
SETSEC         =FA21      64033
SETTRK         =FA1E      64030
SIZE           =1C00      7168
TAB            =09        9
TBASE          = 100      256
TBUFF          =80        128
TDRIVE         =04        4
TFCB           =5C        92
WBOOT          =FA03      64003
WRITE          =FA2A      64042
_LOADEREND     =DC80      56448
_loader         DC00      56320
cprn            DC73      56435
